import{bn as n,bs as U,bz as L,aw as B,bl as ao,bc as F,by as h,ax as x,bC as R,bA as J,bt as to}from"./index.deda044d.js";import{c as O}from"./compactarValidarNFe.1f450579.js";import{c as io}from"./codigosANP.a6c1a264.js";var ro={calculaTotais(o,a,i,s=!0){var r,t,C,m,l,u,I,f,S,v,d,P,M,b,_,D;this.metadados=i;const e={vBC:0,vBCST:0,vICMS:0,vICMSDeson:0,vFCPUFDest:null,vICMSUFDest:null,vICMSUFRemet:null,vFCP:0,vST:0,vICMSST:null,vICMSSTRet:null,vFCPST:0,vFCPSTRet:0,vProd:0,vFrete:0,vSeg:0,vDesc:0,vII:0,vIPI:0,vIPIDevol:0,vPIS:0,vCOFINS:0,vOutro:0,vNF:0,noXml_vTribFed:0,noXml_vTribEst:0,noXml_vTribMun:0,vTotTrib:0},c={vBCIBSCBS:0,gIBS:{gIBSUF:{vIBSUF:0},gIBSMun:{vIBSMun:0},vIBS:0},gCBS:{vCBS:0}};for(const T in o.det){const p=o.det[T],X=p.imposto.escolhas.valor_escolha,w=p.imposto.escolhas[X].ICMS.escolhas.valor_escolha,Y=p.imposto.escolhas[X].ICMS.escolhas[w];if(this.calculaVCredICMSSN(Y,p),s&&(this.distribuiDadosICMS(p,o),this.distribuiDadosPIS(p),this.distribuiDadosCOFINS(p),this.distribuiDadosIPI(p)),a.automatico.dados_trib&&(p.prod.qTrib=p.prod.qCom,p.prod.uTrib=p.prod.uCom,p.prod.vUnTrib=p.prod.vUnCom,p.prod.cEANTrib=p.prod.cEAN),a.automatico.totais){const E=n(p.prod.qCom,4),Z=n(p.prod.vUnCom,4),Q=n(p.prod.qTrib,4),y=n(p.prod.vUnTrib,4),W=n(E*Z,2),H=n(p.prod.vFrete,2),$=n(p.prod.vSeg,2),V=n(p.prod.vOutro,2),q=n(p.prod.vDesc,2),G=a.automatico.incluiDespesasNaBC===!1?0:V,A=n(Q*y+$+G-q,2);if(p.prod.vProd=n(W,2),p.prod.indTot==="1"&&(e.vProd+=W),e.vIPIDevol+=((t=(r=p.impostoDevol)==null?void 0:r.IPI)==null?void 0:t.vIPIDevol)||0,e.vFrete+=H,e.vSeg+=$,e.vOutro+=V,e.vDesc+=q,this.calculaICMS_ISSQN_IPI_II(p,o,a,e,A,E),this.calculaPIS_COFINS("PIS",p,a,e,A,E,o),this.calculaPIS_COFINS("COFINS",p,a,e,A,E,o),this.calculaIBSCBS(p,a,c,A,E,o),this.calculaIBPT(p,a,e),(m=(C=p.imposto)==null?void 0:C.ICMSUFDest)!=null&&m.visivel){const j=(I=(u=(l=p.impostoDevol)==null?void 0:l.IPI)==null?void 0:u.vIPIDevol)!=null?I:0,oo=(f=p.imposto.noXml_vIPI)!=null?f:0,K=n(Q*y+$+H+G-q+j+oo,2),z=p.imposto.ICMSUFDest.pICMSUFDest,k=p.imposto.ICMSUFDest.pICMSInter;p.imposto.ICMSUFDest.vBCUFDest=K,z&&k&&z>k&&(p.imposto.ICMSUFDest.vICMSUFDest=n(K*((z-k)/100),2))}}this.resumeDadosICMS(p),(v=(S=p.imposto)==null?void 0:S.ICMSUFDest)!=null&&v.visivel&&(e.vICMSUFDest||(e.vICMSUFDest=0),e.vFCPUFDest||(e.vFCPUFDest=0),e.vICMSUFDest+=(M=(P=(d=p.imposto)==null?void 0:d.ICMSUFDest)==null?void 0:P.vICMSUFDest)!=null?M:0,e.vFCPUFDest+=(D=(_=(b=p.imposto)==null?void 0:b.ICMSUFDest)==null?void 0:_.vFCPUFDest)!=null?D:0)}if(a.automatico.totais){if(a.calculaTotais){e.vST=e.vICMSST+e.vST,e.vNF=e.vProd+e.vFrete+e.vSeg+e.vOutro+e.vST+e.vFCPST+e.vIPI+e.vIPIDevol-e.vDesc;for(const T in e)e[T]!=null&&(o.total.ICMSTot[T]=n(e[T],2));(c.gCBS.vCBS||c.gIBS.vIBS)&&(o.total.IBSCBSTot.visivel=!0,o.total.IBSCBSTot.vBCIBSCBS=n(c.vBCIBSCBS,2),o.total.IBSCBSTot.gIBS.visivel=!0,o.total.IBSCBSTot.gIBS.gIBSUF.vIBSUF=n(c.gIBS.gIBSUF.vIBSUF,2),o.total.IBSCBSTot.gIBS.gIBSMun.vIBSMun=n(c.gIBS.gIBSMun.vIBSMun,2),o.total.IBSCBSTot.gIBS.vIBS=n(c.gIBS.vIBS,2),o.total.IBSCBSTot.gCBS.visivel=!0,o.total.IBSCBSTot.gCBS.vCBS=n(c.gCBS.vCBS,2))}if(o.pag.detPag.length){if(o.pag.detPag.length===1){const T=o.pag.detPag[0];T.tPag==="90"?T.vPag=0:T.vPag=n(e.vNF)}}else{const T=O.executa(U.infNFe.pag.detPag.lista,{});T.tPag="99",T.xPag="",T.vPag=n(e.vNF),o.pag.detPag.push(T)}}},calculaIBPT(o,a,i){const s=["5949","6949"].includes(o.prod.CFOP)?0:Number(o.prod.vProd)-Number(o.prod.vDesc);o.imposto.noXml_vTribFed=["1","6","7"].includes(o.imposto.noXml_orig)?n(Number(o.imposto.noXml_pTribImp)*s/100):n(Number(o.imposto.noXml_pTribFed)*s/100),i.noXml_vTribFed=n(i.noXml_vTribFed+o.imposto.noXml_vTribFed,2),o.imposto.noXml_vTribEst=n(Number(o.imposto.noXml_pTribEst)*s/100),i.noXml_vTribEst=n(i.noXml_vTribEst+o.imposto.noXml_vTribEst),o.imposto.noXml_vTribMun=n(Number(o.imposto.noXml_pTribMun)*s/100),i.noXml_vTribMun=n(i.noXml_vTribMun+o.imposto.noXml_vTribMun),o.imposto.vTotTrib=n(o.imposto.noXml_vTribFed+o.imposto.noXml_vTribEst+o.imposto.noXml_vTribMun),i.vTotTrib=n(i.vTotTrib+o.imposto.vTotTrib)},distribuiDadosICMS(o,a){const i=o.imposto.noXml_CSOSN||"",s=o.imposto.noXml_CST||"",e=o.imposto.escolhas.opcao1.ICMS.escolhas;if(i||s){o.imposto.escolhas.valor_escolha="opcao1";const r=this.metadados.infNFe.det.lista.imposto.escolhas.opcao1.ICMS.escolhas;for(const t in e)t==="valor_escolha"||t==="ICMSPart"||t==="ICMSST"||t.endsWith("_erro")||(a.emit.CRT==="3"?"CST"in e[t]&&r[t].CST._enumeration.find(l=>l.valor===s)&&(e.valor_escolha=t,e[t].CST=s):"CSOSN"in e[t]&&r[t].CSOSN._enumeration.find(l=>l.valor===i)&&(e.valor_escolha=t,e[t].CSOSN=i))}const c=e[e.valor_escolha];c&&o.imposto.escolhas.valor_escolha==="opcao1"&&(o.imposto.noXml_orig&&this.atualizaCampoRecursivo(c,"orig",o.imposto.noXml_orig),o.imposto.noXml_pICMS&&!["201","202"].includes(i)&&(this.atualizaCampoRecursivo(c,"pICMS",o.imposto.noXml_pICMS),o.imposto.noXml_pICMS=0),o.imposto.noXml_pRedBC&&(this.atualizaCampoRecursivo(c,"pRedBC",o.imposto.noXml_pRedBC),o.imposto.noXml_pRedBC=0),o.imposto.noXml_pFCP&&!["201","202"].includes(i)&&(this.atualizaCampoRecursivo(c,"pFCP",o.imposto.noXml_pFCP),o.imposto.noXml_pFCP=0))},resumeDadosICMS(o){const a=o.imposto.escolhas;if(a.valor_escolha==="opcao1"||!a.valor_escolha){a.valor_escolha="opcao1";const i=a.opcao1.ICMS.escolhas,s=i.valor_escolha,e=i[s];e&&("CST"in e?o.imposto.noXml_CST=e.CST:"CSOSN"in e&&(o.imposto.noXml_CSOSN=e.CSOSN),o.imposto.noXml_orig=this.buscaRecursivo(e,"orig"))}},distribuiDadosPIS(o){const a=o.imposto.noXml_CSTPis||"";if(a){const i=this.metadados.infNFe.det.lista.imposto.PIS.escolhas,s=o.imposto.PIS.escolhas;for(const c in s)c==="valor_escolha"||c.endsWith("_erro")||"CST"in s[c]&&i[c].CST._enumeration.find(C=>C.valor===a)&&(s.valor_escolha=c,s[c].CST=a);const e=s[s.valor_escolha];!!e&&!!o.imposto.noXml_pPIS&&this.atualizaCampoRecursivo(e,"pPIS",o.imposto.noXml_pPIS)}},distribuiDadosCOFINS(o){const a=o.imposto.noXml_CSTCofins||"";if(a){const i=this.metadados.infNFe.det.lista.imposto.COFINS.escolhas,s=o.imposto.COFINS.escolhas;for(const c in s)c==="valor_escolha"||c.endsWith("_erro")||"CST"in s[c]&&i[c].CST._enumeration.find(C=>C.valor===a)&&(s.valor_escolha=c,s[c].CST=a);const e=s[s.valor_escolha];!!e&&!!o.imposto.noXml_pCOFINS&&this.atualizaCampoRecursivo(e,"pCOFINS",o.imposto.noXml_pCOFINS)}},distribuiDadosIPI(o){const a=o.imposto.noXml_CSTIpi||"";if(a){o.imposto.escolhas.valor_escolha="opcao1";const i=o.imposto.escolhas.opcao1.IPI;i.visivel=!0,i.cEnq=o.imposto.noXml_cEnqIpi,this.metadados.infNFe.det.lista.imposto.escolhas.opcao1.IPI.escolhas.IPITrib.CST._enumeration.find(c=>c.valor===a)?(i.escolhas.valor_escolha="IPITrib",i.escolhas.IPITrib.CST=a,i.escolhas.IPITrib.escolhas.valor_escolha="opcao1",i.escolhas.IPITrib.escolhas.opcao1.pIPI=i.escolhas.IPITrib.escolhas.opcao1.pIPI||o.imposto.noXml_pIPI||0):(i.escolhas.valor_escolha="IPINT",i.escolhas.IPINT.CST=a)}},calculaPIS_COFINS(o,a,i,s,e,c,r){let t=null;switch(a.imposto[o].escolhas.valor_escolha){case o+"Aliq":t=a.imposto[o].escolhas[o+"Aliq"],this.calculaImpostoPercentagem(o,t,"vBC","p"+o,t,"v"+o,s,i,e,a,r);break;case o+"Qtde":t=a.imposto[o].escolhas[o+"Qtde"],this.calculaImpostoQuantidade(o,t,"qBCProd","vAliqProd",t,"v"+o,s,i,c);break;case o+"NT":break;case o+"Outr":t=a.imposto[o].escolhas[o+"Outr"],t.escolhas.valor_escolha==="opcao1"?this.calculaImpostoPercentagem(o,t.escolhas.opcao1,"vBC","p"+o,t,"v"+o,s,i,e,a,r):t.escolhas.valor_escolha==="opcao2"&&this.calculaImpostoQuantidade(o,t.escolhas.opcao2,"qBCProd","vAliqProd",t,"v"+o,s,i,c);break}a.imposto[o+"ST"].visivel&&(t=a.imposto[o+"ST"],t.escolhas.valor_escolha==="opcao1"?this.calculaImpostoPercentagem(o,t.escolhas.opcao1,"vBC","p"+o,t,"v"+o,s,i,e):t.escolhas.valor_escolha==="opcao2"&&this.calculaImpostoQuantidade(o,t.escolhas.opcao2,"qBCProd","vAliqProd",t,"v"+o,s,i,c))},calculaIBSCBS(o,a,i,s,e,c){switch(o.imposto.IBSCBS.escolhas.valor_escolha){case"gIBSCBS":const r=o.imposto.IBSCBS.escolhas.gIBSCBS;a.automatico.calculaBC?r.vBC=n(s,2):s=Number(r.vBC),i.vBCIBSCBS+=r.vBC,a.calculaTotais&&(r.gCBS.vCBS=n(s*r.gCBS.pCBS/100,2),r.gIBSUF.vIBSUF=n(s*r.gIBSUF.pIBSUF/100,2),r.gIBSMun.vIBSMun=n(s*r.gIBSMun.pIBSMun/100,2),r.vIBS=n(r.gIBSUF.vIBSUF+r.gIBSMun.vIBSMun,2),i.gCBS.vCBS+=r.gCBS.vCBS,i.gIBS.gIBSUF.vIBSUF+=r.gIBSUF.vIBSUF,i.gIBS.gIBSMun.vIBSMun+=r.gIBSMun.vIBSMun,i.gIBS.vIBS+=r.vIBS);break}},calculaICMS_ISSQN_IPI_II(o,a,i,s,e,c){switch(o.imposto.escolhas.valor_escolha){case"opcao1":this.calculaIPI(o.imposto.escolhas.opcao1.IPI,i,s,e,c,o,a),this.calculaICMS(o,a,i,s,e),this.calculaII(o.imposto.escolhas.opcao1.II,i,s,e);break;case"opcao2":this.calculaISSQN(o.imposto.escolhas.opcao2.ISSQN,i,s,e),this.calculaIPI(o.imposto.escolhas.opcao2.IPI,i,s,e,c,o,a);break}},calculaIPI(o,a,i,s,e,c,r){let t=null;if(o.visivel)switch(o.escolhas.valor_escolha){case"IPITrib":t=o.escolhas.IPITrib,t.escolhas.valor_escolha==="opcao1"?this.calculaImpostoPercentagem("IPI",t.escolhas.opcao1,"vBC","pIPI",t,"vIPI",i,a,s,c,r):t.escolhas.valor_escolha==="opcao2"&&this.calculaImpostoQuantidade("IPI",t.escolhas.opcao2,"qUnid","vUnid",t,"vIPI",i,a,e);break;case"IPINT":t=o.escolhas.IPINT;break}},calculaII(o,a,i,s){o.visivel&&(i.vII+=Number(o.vII))},calculaISSQN(o,a,i,s){this.calculaImpostoPercentagem("ISSQN",o,"vBC","vAliq",o,"vISSQN",i,a,s)},calculaICMS(o,a,i,s,e){const c=o.imposto.escolhas.opcao1.ICMS,r=o.imposto;let t=null;switch(c.escolhas.valor_escolha){case"ICMS00":t=c.escolhas.ICMS00,i.automatico.calculaBC&&(t.modBC="3"),this.calculaImpostoPercentagem("ICMS",t,"vBC","pICMS",t,"vICMS",s,i,e,o,a),t.opcional.visivel&&this.calculaImpostoPercentagem("FCP",t.opcional,"vBCFCP","pFCP",t.opcional,"vFCP",s,i,e,o,a);break;case"ICMS10":t=c.escolhas.ICMS10,i.automatico.calculaBC&&(t.modBC="3"),this.calculaImpostoPercentagem("ICMS",t,"vBC","pICMS",t,"vICMS",s,i,e,o,a),t.opcional.visivel&&this.calculaImpostoPercentagem("FCP",t.opcional,"vBCFCP","pFCP",t.opcional,"vFCP",s,i,e,o,a),t.opcional2.visivel&&this.calculaImpostoFCPST("FCPST",t.opcional2,"vBCFCPST","pFCPST",t.opcional2,"vFCPST",s,i,Number(t.vBCST)||0,Number(t.opcional.vFCP)||0,o),this.calculaImpostoST("ICMSST",t,"vBCST","pICMSST","pMVAST","vICMS",t,"vICMSST",s,i,e,o,a);break;case"ICMS20":t=c.escolhas.ICMS20,this.calculaImpostoPercentagemComReducaoBc("ICMS","vBC","pICMS","pRedBC","vICMS",t,s,i,e,o,a),t.opcional.visivel&&this.calculaImpostoPercentagem("FCP",t.opcional,"vBCFCP","pFCP",t.opcional,"vFCP",s,i,e,o,a);break;case"ICMS30":t=c.escolhas.ICMS30,t.opcional.visivel&&this.calculaImpostoFCPST("FCPST",t.opcional,"vBCFCPST","pFCPST",t.opcional,"vFCPST",s,i,Number(t.vBCST)||0,Number(t.opcional.vFCP)||0,o),this.calculaImpostoST("ICMSST",t,"vBCST","pICMSST","pMVAST","vICMS",t,"vICMSST",s,i,e,o,a);break;case"ICMS40":t=c.escolhas.ICMS40;break;case"ICMS51":t=c.escolhas.ICMS51,this.calculaImpostoPercentagemComReducaoBc("ICMS","vBC","pICMS","pRedBC","vICMS",t,s,i,e,o,a),t.opcional.visivel&&this.calculaImpostoPercentagem("FCP",t.opcional,"vBCFCP","pFCP",t.opcional,"vFCP",s,i,e,o,a);break;case"ICMS60":t=c.escolhas.ICMS60,t.opcional.visivel&&this.calculaImpostoPercentagem("ICMSSTRet",t.opcional,"vBCSTRet","pST",t.opcional,"vICMSSTRet",s,i,e,o,a),t.opcional2.visivel&&this.calculaImpostoPercentagem("FCPSTRet",t.opcional2,"vBCFCPSTRet","pFCPSTRet",t.opcional2,"vFCPSTRet",s,i,e,o,a);break;case"ICMS70":t=c.escolhas.ICMS70,this.calculaImpostoPercentagemComReducaoBc("ICMS","vBC","pICMS","pRedBC","vICMS",t,s,i,e,o,a),t.opcional.visivel&&this.calculaImpostoPercentagem("FCP",t.opcional,"vBCFCP","pFCP",t.opcional,"vFCP",s,i,e,o,a),t.opcional2.visivel&&this.calculaImpostoFCPST("FCPST",t.opcional2,"vBCFCPST","pFCPST",t.opcional2,"vFCPST",s,i,Number(t.vBCST)||0,Number(t.opcional.vFCP)||0,o),this.calculaImpostoST("ICMSST",t,"vBCST","pICMSST","pMVAST","vICMS",t,"vICMSST",s,i,e,o,a);break;case"ICMS90":t=c.escolhas.ICMS90;let C=0;t.opcional.visivel&&(this.calculaImpostoPercentagemComReducaoBc("ICMS","vBC","pICMS","pRedBC","vICMS",t.opcional,s,i,e,o,a),t.opcional.opcional.visivel&&(this.calculaImpostoPercentagem("FCP",t.opcional.opcional,"vBCFCP","pFCP",t.opcional.opcional,"vFCP",s,i,e,o,a),C=Number(t.opcional.opcional.vFCP)||0)),t.opcional2.visivel&&(t.opcional2.vICMS=t.opcional.vICMS,t.opcional2.opcional.visivel&&this.calculaImpostoFCPST("FCPST",t.opcional2.opcional,"vBCFCPST","pFCPST",t.opcional2.opcional,"vFCPST",s,i,Number(t.opcional2.vBCST)||0,C,o),this.calculaImpostoST("ICMSST",t.opcional2,"vBCST","pICMSST","pMVAST","vICMS",t.opcional2,"vICMSST",s,i,e,o,a));break;case"ICMSPart":t=c.escolhas.ICMSPart;break;case"ICMSST":t=c.escolhas.ICMSST;break;case"ICMSSN101":t=c.escolhas.ICMSSN101,this.calculaImpostoST_CSOSN_101_102(t,r,s,o,a,i,e);break;case"ICMSSN102":t=c.escolhas.ICMSSN102;break;case"ICMSSN201":t=c.escolhas.ICMSSN201,this.calculaImpostoST_CSOSN_201_202(t,r,s,o,a,i,e);break;case"ICMSSN202":t=c.escolhas.ICMSSN202,this.calculaImpostoST_CSOSN_201_202(t,r,s,o,a,i,e);break;case"ICMSSN500":t=c.escolhas.ICMSSN500,t.opcional.visivel&&this.calculaImpostoPercentagem("ICMSSTRet",t.opcional,"vBCSTRet","pST",t.opcional,"vICMSSTRet",s,i,e,o,a),t.opcional2.visivel&&this.calculaImpostoPercentagem("FCPSTRet",t.opcional2,"vBCFCPSTRet","pFCPSTRet",t.opcional2,"vFCPSTRet",s,i,e,o,a);break;case"ICMSSN900":t=c.escolhas.ICMSSN900,t.opcional.visivel&&this.calculaImpostoPercentagemComReducaoBc("ICMS","vBC","pICMS","pRedBC","vICMS",t.opcional,s,i,e,o,a),t.opcional2.visivel&&(t.opcional2.vICMS=t.opcional.vICMS,t.opcional2.opcional.visivel&&this.calculaImpostoFCPST("FCPST",t.opcional2.opcional,"vBCFCPST","pFCPST",t.opcional2.opcional,"vFCPST",s,i,Number(t.opcional2.vBCST)||0,Number(t.opcional2.vFCP)||0,o),this.calculaImpostoST("ICMSST",t.opcional2,"vBCST","pICMSST","pMVAST","vICMS",t.opcional2,"vICMSST",s,i,e,o,a));break}},calculaImpostoPercentagem(o,a,i,s,e,c,r,t,C,m,l){if(i in a||console.error("totalEImpostos: Campo "+i+" n\xE3o consta em objetoImposto "),s in a||console.error("totalEImpostos: Campo "+s+" n\xE3o consta em objetoImposto "),c in e||console.error("totalEImpostos: Campo "+c+" n\xE3o consta em objetoImposto "),c in r||console.error("totalEImpostos: Campo "+c+" n\xE3o consta em total"),o==="ICMSSTRet"&&m.imposto.noXml_ICMSSTRet){e.pST=m.imposto.noXml_ICMSSTRet.pST,e.vBCSTRet=m.imposto.noXml_ICMSSTRet.vBCSTRet,e.vICMSSTRet=m.imposto.noXml_ICMSSTRet.vICMSSTRet,e.vICMSSubstituto=m.imposto.noXml_ICMSSTRet.vICMSSubstituto,m.infAdProd=`Base ICMS ST Ret: ${$filters.numero(e.vBCSTRet,2)} / `,m.infAdProd+=`Al\xEDquota ICMS ST Ret: ${$filters.numero(e.pST,2)} / `,m.infAdProd+=`Valor ICMS ST Ret: ${$filters.numero(e.vICMSSTRet,2)} / `,m.infAdProd+=`Valor ICMS Pr\xF3prio (Substituto): ${$filters.numero(e.vICMSSubstituto,2)}`;return}if(~["PIS","COFINS"].indexOf(o)&&(C-=m.imposto.noXml_vICMS),o==="ICMS"&&l.ide.indFinal==="1"&&(C+=m.imposto.noXml_vIPI),o==="ICMS"){const u=l.transp.modFrete==="0",I=m.prod.vFrete;C=C+(u?I:0)}if(C===0||!t.automatico.calculaBC?C=Number(a[i]):C=this.atualizaBC(a,i,t,C),t.calculaTotais){const u=this.atualizaAliquota(a,s,t),I=this.atualizaValorImposto(e,c,C*u/100);r[c]+=I,o==="IPI"&&(m.imposto.noXml_vIPI=I),(o==="ICMS"||o==="ICMSST")&&(i in r||console.error("totalEImpostos: Campo "+i+" n\xE3o consta em total"),r[i]+=C),o==="ICMS"&&(m.imposto.noXml_vICMS=I)}},calculaImpostoST(o,a,i,s,e,c,r,t,C,m,l,u,I){var d,P,M,b;i in a||console.error("totalEImpostos: Campo "+i+" n\xE3o consta em objetoImposto "),s in a||console.error("totalEImpostos: Campo "+s+" n\xE3o consta em objetoImposto "),e in a||console.error("totalEImpostos: Campo "+e+" n\xE3o consta em objetoImposto "),t in r||console.error("totalEImpostos: Campo "+t+" n\xE3o consta em objetoImposto "),t in C||console.error("totalEImpostos: Campo "+t+" n\xE3o consta em total");const f=Number(a[e])||0,S=Number(a[c])||0,v=Number(a[s])||0;if(l===0||!m.automatico.calculaBC)l=Number(a[i])||0;else{const _=I.transp.modFrete==="0",D=I.transp.modFrete==="1",T=u.prod.vFrete,p=I.ide.indFinal==="1";let X=0;Number((d=u==null?void 0:u.imposto)==null?void 0:d.noXml_orig)===1&&Number((P=u==null?void 0:u.imposto)==null?void 0:P.noXml_CST)===10&&(X=(b=(M=u==null?void 0:u.imposto)==null?void 0:M.noXml_vIPI)!=null?b:0);const w=n(l+X+(_||!p&&D?T:0))*(1+f/100);l=this.atualizaBC(a,i,m,w)}m.calculaTotais&&(r[t]=n(l*v/100-S,2),t==="vICMSST"&&(r[t]+=u.imposto.noXml_vFCPST||0),C[t]+=r[t],(o==="ICMS"||o==="ICMSST")&&(i in C||console.error("totalEImpostos: Campo "+i+" n\xE3o consta em total"),C[i]+=l))},calculaVCredICMSSN(o,a){const i=o!=null?o:{};"pCredSN"in i&&"vCredICMSSN"in i&&(o.vCredICMSSN=$utils.arredondar(o.pCredSN/100*Number(a.prod.vProd),2))},calculaImpostoST_CSOSN_101_102(o,a,i,s,e,c,r){!c.automatico.calculaBC||(o.pCredSN=$utils.arredondar(Number(c==null?void 0:c.aliquotaSimples),2),this.calculaVCredICMSSN(o,s))},calculaImpostoST_CSOSN_201_202(o,a,i,s,e,c,r){let t,C,m;if(r===0||!c.automatico.calculaBC)r=Number(a.noXml_vBC)||0,C=Number(a.noXml_vBCFCP)||0,t=Number(o.vBCST)||0,m=Number(o.opcional.vBCFCPST)||0;else{C=r;const l=e.transp.modFrete==="0",u=e.transp.modFrete==="1",I=s.prod.vFrete,f=e.ide.indFinal==="1",S=Number(o.pMVAST)||0;t=n((r+(l||!f&&u?I:0))*(1+S/100)),m=t,a.noXml_vBC=r,a.noXml_vBCFCP=C,o.vBCST=t,o.opcional.vBCFCPST=m}if(c.calculaTotais){const l=Number(a.noXml_pICMS)||0,u=Number(a.noXml_pFCP)||0,I=Number(o.pICMSST)||0,f=Number(o.opcional.pFCPST)||0,S=n(r*l/100,2),v=n(C*u/100,2),d=n(t*I/100-S,2),P=n(m*f/100-v,2);a.noXml_vICMS=S,a.noXml_vFCP=v,o.vICMSST=d,o.opcional.vFCPST=P,a.noXml_vFCPST=P,i.vICMSST+=d,i.vFCPST+=P,i.vBCST+=t}},calculaImpostoFCPST(o,a,i,s,e,c,r,t,C,m,l){i in a||console.error("totalEImpostos: Campo "+i+" n\xE3o consta em objetoImposto "),s in a||console.error("totalEImpostos: Campo "+s+" n\xE3o consta em objetoImposto "),c in e||console.error("totalEImpostos: Campo "+c+" n\xE3o consta em objetoImposto "),c in r||console.error("totalEImpostos: Campo "+c+" n\xE3o consta em total");const u=Number(a[s])||0;C===0||!t.automatico.calculaBC?C=Number(a[i]):C=this.atualizaBC(a,i,t,C),t.calculaTotais&&(e[c]=n(C*u/100-m,2),r[c]+=e[c],c==="vFCPST"&&(l.imposto.noXml_vFCPST=e[c]))},calculaImpostoPercentagemComReducaoBc(o,a,i,s,e,c,r,t,C,m,l){a in c||console.error("totalEImpostos: Campo "+a+" n\xE3o consta em objetoImposto "),i in c||console.error("totalEImpostos: Campo "+i+" n\xE3o consta em objetoImposto "),s in c||console.error("totalEImpostos: Campo "+s+" n\xE3o consta em objetoImposto "),e in c||console.error("totalEImpostos: Campo "+e+" n\xE3o consta em objetoImposto "),e in r||console.error("totalEImpostos: Campo "+e+" n\xE3o consta em total");const u=Number(c[i]),I=Number(c[s]);if(C===0||!t.automatico.calculaBC?C=Number(c[a]):(!!I&&!!u&&(C=n(C-C*(I/100),2)),c[a]=C),t.calculaTotais){const f=n(C*u/100,2);c[e]=f,r[e]+=f,(o==="ICMS"||o==="ICMSST")&&(a in r||console.error("totalEImpostos: Campo "+a+" n\xE3o consta em total"),r[a]+=C)}},calculaImpostoQuantidade(o,a,i,s,e,c,r,t,C){i in a||console.log("Campo "+i+" n\xE3o consta em objetoImposto "),s in a||console.log("Campo "+s+" n\xE3o consta em objetoImposto "),c in e||console.log("Campo "+c+" n\xE3o consta em objetoImposto "),c in r||console.log("Campo "+c+" n\xE3o consta em total");const m=this.atualizaBCquantidade(a,i,C,t),l=this.atualizaAliquotaQuantidade(a,s,t),u=this.atualizaValorImposto(e,c,m*l);r[c]+=u},atualizaBC(o,a,i,s){return i.automatico.calculaBC?o[a]=n(s,2):s=Number(o[a]),s},atualizaAliquota(o,a,i){let s=0;return s=Number(o[a]),s},atualizaValorImposto(o,a,i){return o[a]=n(i,2),n(i,2)},atualizaBCquantidade(o,a,i,s){let e=0;return s.automatico.calculaBC?(e=i,o[a]=n(e,4)):e=Number(o[a]),e},atualizaAliquotaQuantidade(o,a,i){let s=0;return s=Number(o[a]),s},atualizaCampoRecursivo(o,a,i){a in o&&(o[a]=i);for(const s in o){const e=o[s];!!e&&e.constructor===Object&&this.atualizaCampoRecursivo(e,a,i)}},atualizaCampoVisivelRecursivo(o,a,i){a in o&&"visivel"in o&&(o.visivel=i);for(const s in o){const e=o[s];!!e&&e.constructor===Object&&this.atualizaCampoVisivelRecursivo(e,a,i)}},buscaRecursivo(o,a){if(a in o)return o[a];for(const i in o){const s=o[i];if(!!s&&s.constructor===Object){const e=this.buscaRecursivo(s,a);if(e)return e}}return 0}};async function eo(o){var e;const{idItem:a}=o!=null?o:{};let i,s;if(!!a)return i=await $erp().item.get(a),s=JSON.parse((e=i==null?void 0:i.json)!=null?e:null),s==null?void 0:s.icmsSTRet}function g(o,a,i){i in o&&(o[i]=a[i]);for(const s in o){const e=o[s];!!e&&e.constructor===Object&&g(e,a,i)}}function N(o,a,i){i in o&&"visivel"in o&&(o.visivel=!!a[i+"Visivel"]);for(const s in o){const e=o[s];!!e&&e.constructor===Object&&N(e,a,i)}}async function no({infNFe:o,det:a,descricaoProduto:i,item:s,documentoItem:e,cfop:c,empresa:r,destinatario:t,outrosNFe:C},m){var P,M;o.ide.idDest=o.emit.enderEmit.UF===o.dest.enderDest.UF||!o.emit.enderEmit.UF||!o.dest.enderDest.UF||o.ide.mod==="65"?"1":o.dest.enderDest.UF==="EX"?"3":"2";let l=s.ncm||"";l=l.length===8?l:L(l);const u={emitente:{regime:o.emit.CRT,uf:o.emit.enderEmit.UF,tributacaoSetor:r.tributacaoSetor,tributacao:r.tributacao},destinatario:{regime:t.regime==="SimplesNacional"?"1":t.regime==="Normal"?"3":void 0,uf:o.dest.enderDest.UF,pessoa:{CPF:"PF",CNPJ:"PJ",idEstrangeiro:"Estrangeiro"}[o.dest.enderDest.UF==="EX"?"idEstrangeiro":o.dest.escolhas.valor_escolha]||void 0,tributacaoSetor:t.tributacaoSetor,tributacao:t.tributacao,indicadorIE:o.dest.indIEDest,consumidor:o.ide.indFinal==="0"?"N":o.ide.indFinal==="1"?"S":void 0,destino:o.ide.idDest},ncm:l,idItem:s.id,cfop:String(c||""),cest:s.cest,origemMercadoria:String(s.codigoOrigem||""),produto:s.descricao},I=await B.configuracaoImposto.pesquisa(u,m);if(!I||!I.ordem||!I.saida)return;u.emitente.uf!==u.destinatario.uf&&~["2","9"].indexOf(u.destinatario.indicadorIE)&&(a.imposto.ICMSUFDest.visivel=!0,a.imposto.ICMSUFDest.pFCPUFDest=Number(I.saida.icmsInterestadual.pFCPUFDest||0),a.imposto.ICMSUFDest.pICMSInter=String(Number(I.saida.pICMS).toFixed(2)),a.imposto.ICMSUFDest.pICMSInterPart=Number(I.saida.icmsInterestadual.pICMSInterPart||0),a.imposto.ICMSUFDest.pICMSUFDest=Number(I.saida.icmsInterestadual.pICMSUFDest||0),a.imposto.ICMSUFDest.pRedBCSTInter=Number(I.saida.icmsInterestadual.pRedBCSTInter||0));const f=a.prod,S=a.imposto,v=ao(I.saida);f.CFOP=I.entrada.cfop,f.cBenef=I.saida.cBenef,S.noXml_orig=I.entrada.origemMercadoria,S.noXml_CST=v.cstCsosn,S.noXml_CSOSN=v.cstCsosn,S.noXml_pICMS=v.pICMS||0,S.noXml_pRedBC=(P=Number(I.saida.icmsInterestadual.pRedBC))!=null?P:0,S.noXml_pFCP=v.pFCP||0,v.pMVAST=v.pMVAST||0,v.pRedBC=(M=Number(I.saida.icmsInterestadual.pRedBC))!=null?M:0,g(S,v,"modBC"),g(S,v,"modBCST"),g(S,v,"pFCP"),g(S,v,"pFCPST"),g(S,v,"pFCPST"),g(S,v,"pFCPSTRet"),g(S,v,"pICMS"),g(S,v,"pICMSEfet"),g(S,v,"pICMSST"),g(S,v,"pMVAST"),g(S,v,"pRedBC"),g(S,v,"pST"),N(S,v,"pFCP"),N(S,v,"pFCPST"),N(S,v,"pFCPSTRet"),N(S,v,"pICMSEfet"),N(S,v,"pST"),S.noXml_ICMSSTRet=await eo({idItem:f.noXml_id}),S.noXml_CSTPis=v.pisCst,S.noXml_pPIS=v.pPIS||0,S.noXml_CSTCofins=v.cofinsCst,S.noXml_pCOFINS=v.pCOFINS||0,I.entrada.cest&&(f.opcional.visivel=!0,f.opcional.CEST=L(I.entrada.cest)),C.observacoesNFe||(C.observacoesNFe={});const d=(I.saida.observacaoNFe||"").trim();(s==null?void 0:s.id)&&!C.observacoesNFe[s.id]&&d&&(C.observacoesNFe[s.id]=d),v.ipiVisivel&&(S.noXml_CSTIpi=o.ide.tpNF==="1"?v.ipiCstEntrada:v.ipiCstSaida,S.noXml_pIPI=f.noXml_pIPI||v.pIPI||0,S.noXml_cEnqIpi=v.ipiCEnq||0),v.ibsCbsVisivel&&S.IBSCBS&&(S.IBSCBS.visivel=!0,S.IBSCBS.CST=v.ibsCbsCst,S.IBSCBS.cClassTrib=v.cClassTrib,S.IBSCBS.escolhas.valor_escolha="gIBSCBS",S.IBSCBS.escolhas.gIBSCBS.gCBS.pCBS=v.pCBS,S.IBSCBS.escolhas.gIBSCBS.gIBSUF.pIBSUF=v.pIBSUF,S.IBSCBS.escolhas.gIBSCBS.gIBSMun.pIBSMun=v.pIBSMun)}async function So(o,a){const i=(await B.configuracoes.leValorComFiltroEmpresa("nfe.autorizadoDownloadXml",a)).split(" ");for(const s of i){const e=O.executa(U.infNFe.autXML.lista,{},this.tipo),c=L(s);c.length===14?(e.escolhas.valor_escolha="CNPJ",e.escolhas.CNPJ=c,o.autXML.push(e)):c.length===11&&(e.escolhas.valor_escolha="CPF",e.escolhas.CPF=c,o.autXML.push(e))}}async function uo(o,a){o.ide.serie=String(await B.configuracoes.leValorNumericoComFiltroEmpresa(this.serie,a,1)),o.ide.nNF=String(await B.documentoFiscalEletronico.proximoNumero(o.ide.tpAmb,o.emit.escolhas.valor_escolha==="CPF"?o.emit.escolhas.CPF:o.emit.escolhas.CNPJ,o.ide.mod,o.ide.serie,a))}async function Co(o,a){F.log("gerarJsonBaseD","obterConfiguracaoImposto"),o.descricaoProduto=`Produto '${o.documentoItem.descricaoItem||""}'`,h(!o.item.ncm,`${o.descricaoProduto} sem cadastro de NCM`);let i;o.outrosNFe.cfop?(i=await x().cfop.where({cfop:Number(o.outrosNFe.cfop)}).first(),h(!i,"CFOP inv\xE1lido")):(h(!o.documentoItem.idCfop,`${o.descricaoProduto} sem CFOP definido`),i=await x().cfop.get(o.documentoItem.idCfop),h(!i,`${o.descricaoProduto} com CFOP inv\xE1lido`)),o.cfop=i.cfop,await this.gerarConfiguracaoImposto(o,a)}async function po(o){var a,i;if(F.log("gerarJsonBaseD","obterFatura"),o.documentoFatura=await $db.hibrido.le({table:"documento",id:o.idDocumento}),h(!o.documentoFatura,"N\xE3o foi poss\xEDvel carregar a fatura/venda"),o.documentosAdicionais=await $db.hibrido.lista({table:"documento",where:{idDocumentoAdicional:o.idDocumento}}),o.documentosVendas=await $db.hibrido.lista({table:"documento",where:{idFatura:o.idDocumento}}),o.idsDocumentos=[o.idDocumento,...o.documentosAdicionais.map(s=>s.id),...o.documentosVendas.map(s=>s.id)],F.log("gerarJsonBaseD",{documentoFatura:o.documentoFatura,documentosAdicionais:o.documentosAdicionais,documentosVendas:o.documentosVendas}),o.totalDesconto=n((o.documentoFatura.totalDesconto||0)+R(o.documentosVendas,"totalDesconto")),o.documentoFatura.tipo==="Venda")o.totalFrete=n(o.documentoFatura.valorFrete||0),o.tipoFrete=o.documentoFatura.tipoFrete;else{o.totalFrete=n(R(o.documentosVendas,"valorFrete")),o.tipoFrete=(i=(a=o.documentosVendas)==null?void 0:a.find(s=>s.tipoFrete))==null?void 0:i.tipoFrete;for(const s of o.documentosVendas)s.tipo!=="Envelope"&&h(o.tipoFrete!==s.tipoFrete,"Diverg\xEAncia de frete entre as vendas, favor emitir a nota individualmente (por venda)")}o.tipoFrete==="FOB"?o.infNFe.transp.modFrete="1":o.infNFe.transp.modFrete=n(o.totalFrete)===0?"9":o.tipoFrete==="CIF"?"0":o.tipoFrete==="FOB"?"1":"9",o.tipo!=="NFe"&&(o.totalFrete=0),o.infNFe.ide.natOp=o.outrosNFe.operacao?o.outrosNFe.operacao:o.infNFe.ide.finNFe==="4"?"Devolu\xE7\xE3o":"Venda",this.tipo==="NFCe"&&(o.infNFe.infAdic.visivel=!0,o.infNFe.infAdic.infCpl=J(await B.configuracoes.leValorComFiltroEmpresa("cupom.mensagem",o.documentoFatura.idEmpresa,"Obrigado e Volte Sempre!")),await B.configuracoes.leValorNumerico("nfce.offline")===1&&(o.infNFe.ide.tpEmis="9",o.infNFe.ide.opcional.visivel=!0,o.infNFe.ide.opcional.dhCont=to.formatarDataNFe(new Date),o.infNFe.ide.opcional.xJust="Internet indisponivel")),o.outrosNFe.idDocumento=o.idDocumento}function vo(o={}){var i;const a=[];for(const s in((i=o.outrosNFe)==null?void 0:i.observacoesNFe)||{}){const e=o.outrosNFe.observacoesNFe[s];let c=a.find(r=>r.msg===e);c||(c={msg:e},a.push(c))}o.outrosNFe.observacoesNFe="";for(const s of a)o.outrosNFe.observacoesNFe&&(o.outrosNFe.observacoesNFe+=" "),o.outrosNFe.observacoesNFe+=s.msg}function Io(o={}){if(o.infNFe.total.ICMSTot.vTotTrib<.01)return;const a=o.infNFe.total.ICMSTot.vProd-o.infNFe.total.ICMSTot.vDesc;o.outrosNFe.textoValorAproximadosTributos="[Valores aproximados dos tributos: R$ "+$utils.formatarNumero(o.infNFe.total.ICMSTot.vTotTrib,2)+" ("+$utils.formatarNumero(100*o.infNFe.total.ICMSTot.vTotTrib/a,2)+"%)  Federais: R$ "+$utils.formatarNumero(o.infNFe.total.ICMSTot.noXml_vTribFed,2)+" ("+$utils.formatarNumero(100*o.infNFe.total.ICMSTot.noXml_vTribFed/a,2)+"%)  Estaduais: R$ "+$utils.formatarNumero(o.infNFe.total.ICMSTot.noXml_vTribEst,2)+" ("+$utils.formatarNumero(100*o.infNFe.total.ICMSTot.noXml_vTribEst/a,2)+"%)  Municipais: R$ "+$utils.formatarNumero(o.infNFe.total.ICMSTot.noXml_vTribMun,2)+" ("+$utils.formatarNumero(100*o.infNFe.total.ICMSTot.noXml_vTribMun/a,2)+"%) Fonte: IBPT.] "}async function mo(o){var r,t,C,m;if(F.log("gerarJsonBaseD","obterFormasPagamento"),o.documentosPagamento=await $db.hibrido.lista({table:"documentoCondicaoPagamento",where:{idDocumento:o.idDocumento}}),o.documentosPagamento.length===0&&["Venda","Envelope"].includes(o.documentoFatura.tipo)){h(!o.documentoFatura.idFatura,"A venda n\xE3o tem pagamento e n\xE3o pertence a uma fatura");const l=await $db.hibrido.le({table:"documento",id:o.documentoFatura.idFatura});h(!l,"N\xE3o foi poss\xEDvel carregar a fatura da venda"),o.documentosPagamento=await $db.hibrido.lista({table:"documentoCondicaoPagamento",where:{idDocumento:l.id}}),o.vendaSemPagamento=!0}h(!o.documentosPagamento.length&&!o.vendaSemPagamento,"N\xE3o h\xE1 pagamentos"),F.log("gerarJsonBaseD","documentosPagamento",o.documentosPagamento);const a=[];for(const l of o.documentosPagamento){const u=await this.obterMeioPagamento(o,l.idFormaPagamento),I=await $erp().formaPagamento.get(l.idFormaPagamento);let f=a.find(S=>S.tPag===u&&S.card.cAut===l.autorizacao);if(f)f.vPag=n(f.vPag+l.valor);else{if(f=O.executa(U.infNFe.pag.detPag.lista,{},this.tipo),f.tPag=u,f.vPag=n(l.valor),["03","04","17"].includes(u)){let S;I.idContatoOperadoraCartao&&(S=await $erp().contato.get(I.idContatoOperadoraCartao),S&&(S.numeroDocumentoNacional=(r=S.numeroDocumentoNacional)==null?void 0:r.replace(/\D/g,""))),f.card.visivel=!0,f.card.tpIntegra=I.tef?"1":"2",((t=S==null?void 0:S.numeroDocumentoNacional)==null?void 0:t.length)===14&&(f.card.CNPJ=S.numeroDocumentoNacional),f.card.cAut=l.autorizacao}u==="99"&&(f.xPag=$utils.removerCaracteresEspeciais(((C=I==null?void 0:I.descricao)!=null?C:"").trim())),a.push(f)}}h(a.length===0&&!o.vendaSemPagamento,"N\xE3o h\xE1 pagamentos"),o.totalProdutos=n(o.totalProdutos);const i=await $db.hibrido.lista({table:"financeiroTitulo",where:{idFatura:o.idDocumento}}),s=n(R(a,"vPag"));n(R(i,"valorTotal")+o.totalServicos);const e=n(o.totalProdutos+o.totalFrete+o.totalDevolucao-o.totalDesconto-(((m=o.documentoFatura)==null?void 0:m.totalBonus)||0)-a.reduce((l,u)=>u.tPag==="90"?u.vPag:0,0));for(const l of a)l.tPag!=="99"&&delete l.xPag,l.tPag==="90"&&(l.vPag=0);if(s>0&&s!==e){for(const u of a)u.vPag=n(u.vPag*e/s);const l=n(R(a,"vPag"));for(const u of a)u.tPag!=="90"&&(u.vPag=n(u.vPag+e-l))}const c=n(-o.totalDevolucao);c>0&&o.totalProdutos>0&&a.push({tPag:"99",xPag:"Credito de Devolucao",vPag:c}),o.infNFe.pag.detPag=a}async function fo(o){if(o.totalFrete>0){const a=[];for(const s of o.infNFe.det){const e=s.prod;a.push({id:e.noXml_idDocumentoItem,valor:e.qCom*e.vUnCom-e.vDesc})}const i=$utils.ratear({itens:a,saldo:o.totalFrete});for(const s of o.infNFe.det){const e=s.prod,c=i.find(r=>r.id===e.noXml_idDocumentoItem);e.vFrete=(c==null?void 0:c.parcela)||0}}}async function Po(o,a){var m;F.log("gerarJsonBaseD","obterItens");const i=(await $db.hibrido.lista({table:"documentoItem",whereIn:{idDocumento:o.idsDocumentos}})).sort((l,u)=>String(l.dataHoraEmissao||"").localeCompare(String(u.dataHoraEmissao||""))),s=await $db.hibrido.lista({table:"documento",whereIn:{id:o.idsDocumentos}});h(!i,"N\xE3o foi poss\xEDvel carregar os produtos"),F.log("gerarJsonBaseD","documentosItens",i);const e=await B.configuracoes.leValorNumericoComFiltroEmpresa(this.usadesconto,o.outrosNFe.idContatoEmitente,1),c=await B.configuracoes.leValorNumerico("imposto.versao"),r=[];for(const l of i){let u=n(l.total||0);if(!l.idItem)continue;if(["Servi\xE7o"].includes(l.tipoItem)){o.totalServicos+=u;continue}if(o.infNFe.ide.finNFe==="4"){if(!(u<0)){o.totalDevolucao+=u;continue}}else if(u<0){o.totalDevolucao+=u;continue}const I=n(l.quantidade||1,4);let f=n(l.valorItem||0,4),S=n(l.descontoItem||0,4),v=n((l.descontoTotalRateado||0)+(l.descontoFaturaRateado||0),4);if(F.log("gerarJsonBaseD",{quantidade:I,valorUnitarioItem:f,descontoUnitarioItem:S,descontoRateadoItem:v,valorUnitarioItemComDesconto:f-S-v/I,valorUnitarioItemComDescontoA:n(f-S-v/I,4),totalItem:u,tipoItem:l.tipoItem,idItem:l.idItem,descricaoItem:l.descricaoItem}),["TLOE","TLOD"].includes(l.tipoItem))continue;if(["LOE","LOD"].includes(l.tipoItem)){let T=[];o.infNFe.ide.finNFe==="4"?T=i.filter(p=>p.tipoItem==="TLOE"&&l.tipoItem==="LOE"||p.tipoItem==="TLOD"&&l.tipoItem==="LOD"):T=i.filter(p=>["TLOE","TLOD"].includes(p.tipoItem)&&p.idDocumentoItemPai===l.id),F.log("gerarJsonBaseD","tratamentos",T);for(const p of T)S+=n(p.descontoItem||0,4),v+=n((p.descontoTotalRateado||0)+(p.descontoFaturaRateado||0),4),f=n(f+p.valorItem||0,4),u+=p.total||0}if(n(u)===0)continue;let d=n(S*I+v);e===0&&(f=n(f-S-v/I,4),d=0),o.totalProdutos+=u,o.documentoItem=l,o.item=await x().item.get(l.idItem),h(!o.item,"N\xE3o foi poss\xEDvel carregar o cadastro do produto"),o.det=O.executa(U.infNFe.det.lista,{},this.tipo);const P=o.det.prod;let M=String(o.item.codigoBarras||"").padStart(13,"0");if(M.startsWith("999")&&(M="SEM GTIN"),P.cProd=J(String(o.item.referencia||o.item.codigoItem||"0").trim()),P.cEAN=M,P.xProd=J(l.descricaoItem).substr(0,120).trim(),P.NCM=String(o.item.ncm||""),P.uCom=String(o.item.unidade||"UN").trim(),P.qCom=I||0,P.vUnCom=f||0,P.vDesc=d||0,o.infNFe.ide.finNFe==="4"&&(P.vUnCom=-P.vUnCom,P.vDesc=-P.vDesc),P.noXml_id=l.idItem,P.noXml_idDocumentoItem=l.id,this.tipo==="NFe"){const T=(m=o==null?void 0:o.documentosVendas)==null?void 0:m.find(({id:p})=>p===l.idDocumento);T!=null&&T.numeroOrdemCompra&&(P.xPed=String(T.numeroOrdemCompra),P.nItemPed=String(r.length+1))}if(l.loteEmpresa&&l.dataValidadeLote&&l.dataFabricacaoLote&&P.rastro.push({nLote:l.loteEmpresa,qLote:l.quantidade,dFab:new Date(l.dataFabricacaoLote).toISOString().slice(0,10),dVal:new Date(l.dataValidadeLote).toISOString().slice(0,10)}),o.item.codigoANP){P.escolhas.valor_escolha="comb",P.escolhas.comb.cProdANP=o.item.codigoANP;let T=io.tabelaANP.find(p=>p.value===o.item.codigoANP);T&&(P.escolhas.comb.descANP=T.label),T||(P.escolhas.comb.descANP="C\xF3digo n\xE3o encontrado na tabela da ANP."),o.infNFe.dest.enderDest.UF&&(P.escolhas.comb.UFCons=o.infNFe.dest.enderDest.UF)}const b=Math.abs(l.valorRealTotal),_=Math.abs(l.valorIpi),D=Math.abs(l.percentualIpi);b&&_&&(P.noXml_pIPI=n(D)||n(_/b*100)),o.pesoL=n((o.pesoL||0)+Number(o.item.peso||0)*Number(I||1),3),o.pesoB=n((o.pesoB||0)+Number(o.item.pesoBruto||0)*Number(I||1),3),c===2?await this.obterConfiguracaoImpostoV2(o,a):await this.obterConfiguracaoImposto(o),r.push(o.det)}if(o.infNFe.ide.finNFe==="4")h(r.length===0,"N\xE3o h\xE1 produtos para devolu\xE7\xE3o");else if(h(r.length===0,"N\xE3o h\xE1 produtos vendidos"),o.outrosNFe.operacao!=="Remessa")for(const l of r)await this.obterAliquotasTributosIbpt(o,l);const t=O.executa(U.infNFe.transp.vol.lista,{},this.tipo),C=s.reduce((l,u)=>l+(Number(u.numeroVolumeTransporte)||0),0);t.esp="",C>0&&(t.esp=C===1?"VOLUME":"VOLUMES"),t.qVol=String(C||""),t.pesoL=o.pesoL,t.pesoB=o.pesoB,o.infNFe.transp.vol.push(t),F.log("gerarJsonBaseD","itens",r),o.infNFe.det=r}export{So as a,uo as b,po as c,vo as d,Io as e,mo as f,no as g,fo as h,Po as i,Co as o,ro as t};
